#!/bin/bash

#
# replace - DevOpsBroker utility for replacing text in one or more files
#
# Copyright (C) 2018 AUTHOR_NAME <email@address.com>
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.
#
# -----------------------------------------------------------------------------
# Developed on Ubuntu 16.04.4 LTS running kernel.osrelease = 4.13.0-45
#
# -----------------------------------------------------------------------------
#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Preprocessing ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Load /etc/devops/ansi.conf if ANSI_CONFIG is unset
if [ -z "$ANSI_CONFIG" ] && [ -f /etc/devops/ansi.conf ]; then
	source /etc/devops/ansi.conf
fi

${ANSI_CONFIG?"[1;91mCannot load '/etc/devops/ansi.conf': No such file[0m"}

# Load /etc/devops/exec.conf if EXEC_CONFIG is unset
if [ -z "$EXEC_CONFIG" ] && [ -f /etc/devops/exec.conf ]; then
	source /etc/devops/exec.conf
fi

${EXEC_CONFIG?"[1;91mCannot load '/etc/devops/exec.conf': No such file[0m"}

# Load /etc/devops/functions.conf if FUNC_CONFIG is unset
if [ -z "$FUNC_CONFIG" ] && [ -f /etc/devops/functions.conf ]; then
	source /etc/devops/functions.conf
fi

${FUNC_CONFIG?"[1;91mCannot load '/etc/devops/functions.conf': No such file[0m"}

################################## Variables ##################################

## Options
foo_foo_foo_foo_foo_foo_foo_foo_recursive=false
regEx=''
updatedText=''
fileName=''

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ OPTION Parsing ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Display usage if no parameters given
if [ -z "$1" ]; then
  printUsage 'replace [-R] REGEX UPDATED_TEXT [FILE]'

  exit 1
fi

while [[ "$1" =~ ^- ]]; do

  if [ "$1" == '-R' ]; then
    foo_foo_foo_foo_foo_foo_foo_foo_recursive=true
    shift

  # Display error and usage if invalid option specified
  else
    printError 'replace' "Invalid option: '$1'"
    echo
    printUsage 'replace [-R] REGEX UPDATED_TEXT'

    exit 1
  fi
done

regEx="$1"
updatedText="$2"
fileName="$3"

# Display error and usage if missing regex parameter
if [ -z "$regEx" ]; then
  printError 'replace' 'Missing regex parameter'
  echo
  printUsage 'replace [-R] REGEX UPDATED_TEXT'

  exit 1
fi

# Display error and usage if missing updated text parameter
if [ -z "$updatedText" ]; then
  printError 'replace' 'Missing updated text parameter'
  echo
  printUsage "replace [-R] $regEx UPDATED_TEXT"

  exit 1
fi

# Display error and usage if file parameter is invalid
if [ ! -z "$fileName" ] && [ ! -f "$fileName" ]; then
  printError 'replace' "Cannot access '$fileName': No such file"
  echo
  printUsage "replace $regEx $updatedText FILE"

  exit 1
fi

# Escape special characters
FWD_SLASH='/'
FWD_SLASH_ESCAPE='\/'

regEx="${regEx//"$FWD_SLASH"/"$FWD_SLASH_ESCAPE"}"
updatedText="${updatedText//"$FWD_SLASH"/"$FWD_SLASH_ESCAPE"}"


################################### Actions ###################################

if [ $foo_foo_foo_foo_foo_foo_foo_foo_recursive == 'true' ]; then

  # Execute foo_foo_foo_foo_foo_foo_foo_foo_recursive sed on current directory
  $EXEC_FIND . -path '*/.git' -prune -o -type f -print0 | $EXEC_XARGS -r -0 $EXEC_SED -i -e "s/$regEx/$updatedText/gw /dev/stdout"

else

  $EXEC_SED -i -e "s/$regEx/$updatedText/gw /dev/stdout" "$fileName" | $EXEC_GREP -n "$updatedTextTo"
  #$EXEC_RM "/tmp/$USER-replace.out"

fi

exit 0
